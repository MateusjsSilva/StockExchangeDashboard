<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Stock Exchange Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .stock-up { color: green; }
        .stock-down { color: red; }
        .connection-error { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Cotações em Tempo Real</h1>
        <div class="alert alert-info" id="connection-status">Conectando ao servidor...</div>
        
        <div class="row">
            <!-- Botão para reconectar manualmente -->
            <div class="col-12 mb-3">
                <button id="reconnect-button" class="btn btn-primary">Reconectar</button>
            </div>
            
            <div class="col-md-6">
                <h3>Cotações</h3>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Símbolo</th>
                            <th>Preço</th>
                            <th>Variação</th>
                            <th>%</th>
                        </tr>
                    </thead>
                    <tbody id="stocks-table">
                        <!-- Dados serão inseridos aqui -->
                    </tbody>
                </table>
            </div>
            <div class="col-md-6">
                <h3>Log de Eventos</h3>
                <div class="card">
                    <div class="card-body" style="height: 400px; overflow-y: auto;">
                        <ul class="list-group" id="events-log">
                            <!-- Log de eventos serão inseridos aqui -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const stockPrices = {};
            let connectionRetries = 0;
            const maxRetries = 5;
            
            // Obter a URL base do servidor atual
            const baseUrl = window.location.origin;
            let connection;
            
            function setupConnection() {
                logEvent(`Tentando conectar ao servidor: ${baseUrl}`);
                
                // Iniciar a conexão com SignalR - Configuração alternativa para resolver "Failed to fetch"
                connection = new signalR.HubConnectionBuilder()
                    .withUrl(`${baseUrl}/stockHub`, {
                        skipNegotiation: true, // Pular negociação para resolver o erro
                        transport: signalR.HttpTransportType.WebSockets
                    })
                    .withAutomaticReconnect([0, 1000, 5000, 10000])
                    .configureLogging(signalR.LogLevel.Debug) // Mais detalhes de log
                    .build();
                
                connection.onreconnecting(error => {
                    const statusDiv = document.getElementById('connection-status');
                    statusDiv.textContent = `Reconectando: ${error ? error.message : 'Conexão perdida'}`;
                    statusDiv.className = 'alert alert-warning connection-error';
                    logEvent('Tentando reconectar ao servidor...');
                });
                
                connection.onreconnected(connectionId => {
                    const statusDiv = document.getElementById('connection-status');
                    statusDiv.textContent = `Reconectado! ID: ${connectionId}`;
                    statusDiv.className = 'alert alert-success';
                    logEvent('Conexão restabelecida!');
                    connectionRetries = 0;
                });
                
                connection.onclose(error => {
                    const statusDiv = document.getElementById('connection-status');
                    statusDiv.textContent = 'Conexão fechada';
                    statusDiv.className = 'alert alert-danger';
                    logEvent('Conexão fechada: ' + (error ? error.message : 'Desconectado'));
                    
                    // Tentar reconectar manualmente após um tempo
                    if (connectionRetries < maxRetries) {
                        connectionRetries++;
                        setTimeout(() => {
                            logEvent(`Tentativa de reconexão manual #${connectionRetries}`);
                            startConnection();
                        }, 3000);
                    }
                });
                
                // Manipulador para mensagem de boas-vindas
                connection.on('Welcome', message => {
                    logEvent('Conexão estabelecida: ' + message);
                    document.getElementById('connection-status').textContent = 'Conectado ao servidor';
                    document.getElementById('connection-status').className = 'alert alert-success';
                    connectionRetries = 0;
                });
                
                // Manipulador para atualizações individuais (original)
                connection.on('ReceiveStockUpdate', stockUpdate => {
                    stockPrices[stockUpdate.symbol] = stockUpdate;
                    updateStockTable();
                    
                    if (Math.random() < 0.05) {
                        logEvent(`${stockUpdate.symbol}: ${stockUpdate.price.toFixed(2)} (${stockUpdate.percentChange > 0 ? '+' : ''}${stockUpdate.percentChange.toFixed(2)}%)`);
                    }
                });
                
                // Manipulador para atualizações em lote
                connection.on('ReceiveStockUpdates', updates => {
                    if (updates && updates.length) {
                        updates.forEach(stockUpdate => {
                            stockPrices[stockUpdate.symbol] = stockUpdate;
                        });
                        
                        updateStockTable();
                        logEvent(`Recebidas ${updates.length} atualizações de cotações`);
                    }
                });
            }
            
            async function startConnection() {
                const statusDiv = document.getElementById('connection-status');
                statusDiv.textContent = 'Conectando ao servidor...';
                statusDiv.className = 'alert alert-info';
                
                if (!connection) {
                    setupConnection();
                }
                
                try {
                    await connection.start();
                    logEvent('Conexão SignalR iniciada');
                } catch (err) {
                    statusDiv.textContent = `Erro na conexão: ${err.message}`;
                    statusDiv.className = 'alert alert-danger';
                    logEvent(`Erro na conexão: ${err.message}`);
                    
                    // Se falhar, tente com uma configuração alternativa
                    if (connectionRetries === 1) {
                        logEvent('Tentando conexão com configuração alternativa...');
                        // Tentar uma segunda abordagem de conexão
                        connection = new signalR.HubConnectionBuilder()
                            .withUrl(`${baseUrl}/stockHub`, {
                                skipNegotiation: false, // Tentar com negociação
                                transport: signalR.HttpTransportType.LongPolling // Usar long polling como fallback
                            })
                            .withAutomaticReconnect()
                            .build();
                        
                        // Reconfigurar handlers...
                        setupConnection();
                    }
                    
                    // Tentar novamente após 5 segundos
                    if (connectionRetries < maxRetries) {
                        connectionRetries++;
                        setTimeout(startConnection, 5000);
                    }
                }
            }
            
            // Configurar botão de reconexão manual
            document.getElementById('reconnect-button').addEventListener('click', () => {
                logEvent('Reconexão manual iniciada');
                connectionRetries = 0;
                
                if (connection) {
                    connection.stop().catch(err => console.error(err));
                }
                
                setTimeout(startConnection, 1000);
            });
            
            // Iniciar conexão
            startConnection();
            
            // Função para atualizar a tabela de ações
            function updateStockTable() {
                const tbody = document.getElementById('stocks-table');
                tbody.innerHTML = '';
                
                // Ordenar por símbolo
                const sortedSymbols = Object.keys(stockPrices).sort();
                
                for (const symbol of sortedSymbols) {
                    const stock = stockPrices[symbol];
                    const row = document.createElement('tr');
                    
                    // Símbolo
                    const symbolCell = document.createElement('td');
                    symbolCell.textContent = stock.symbol;
                    row.appendChild(symbolCell);
                    
                    // Preço
                    const priceCell = document.createElement('td');
                    priceCell.textContent = stock.price.toFixed(2);
                    row.appendChild(priceCell);
                    
                    // Variação
                    const changeCell = document.createElement('td');
                    changeCell.textContent = (stock.change > 0 ? '+' : '') + stock.change.toFixed(2);
                    changeCell.className = stock.change >= 0 ? 'stock-up' : 'stock-down';
                    row.appendChild(changeCell);
                    
                    // Percentual
                    const percentCell = document.createElement('td');
                    percentCell.textContent = (stock.percentChange > 0 ? '+' : '') + stock.percentChange.toFixed(2) + '%';
                    percentCell.className = stock.percentChange >= 0 ? 'stock-up' : 'stock-down';
                    row.appendChild(percentCell);
                    
                    tbody.appendChild(row);
                }
            }
            
            // Função para registrar eventos
            function logEvent(message) {
                const log = document.getElementById('events-log');
                const item = document.createElement('li');
                item.className = 'list-group-item';
                
                const time = new Date().toLocaleTimeString();
                item.textContent = `[${time}] ${message}`;
                
                log.insertBefore(item, log.firstChild);
                
                if (log.children.length > 100) {
                    log.removeChild(log.lastChild);
                }
                
                console.log(`[${time}] ${message}`);
            }
            
            // Registrar URL atual para depuração
            logEvent(`Base URL: ${baseUrl}`);
        });
    </script>
</body>
</html>